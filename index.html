<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Candle Workshop - Multi-Language</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF6B9D;
            --secondary: #FEC260;
            --accent: #4ECDC4;
            --dark: #2D3561;
            --light: #FFF9F0;
            --gradient-1: linear-gradient(135deg, #FF6B9D 0%, #C44569 100%);
            --gradient-2: linear-gradient(135deg, #FEC260 0%, #F77062 100%);
            --gradient-3: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #FFF9F0 0%, #FFE6F0 50%, #E6F7F5 100%);
            color: var(--dark);
            min-height: 100vh;
        }

        .header {
            background: var(--gradient-1);
            color: white;
            padding: 1.25rem 1.5rem;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .header h1 { font-family: 'Playfair Display', serif; font-size: 1.6rem; display:flex; align-items:center; gap:0.5rem; }
        .header p { opacity: 0.95; margin-top: 0.25rem; font-size: 0.9rem; }

        .lang-selector { display:flex; gap:0.5rem; background: rgba(255,255,255,0.18); padding:0.35rem; border-radius:10px; }
        .lang-btn { border: none; background: transparent; color: white; cursor:pointer; padding:0.35rem 0.6rem; border-radius:8px; font-weight:700; }
        .lang-btn.active { background: white; color: var(--primary); }

        .container { max-width:1200px; margin: 2rem auto; padding: 0 1rem; }

        .tabs { display:flex; gap:0.5rem; margin-bottom:1rem; flex-wrap:wrap; }
        .tab-btn { background: white; border: none; padding:0.6rem 1rem; border-radius:12px; cursor:pointer; font-weight:600; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
        .tab-btn.active { background: var(--gradient-1); color: white; }

        .card { background:white; border-radius:16px; padding:1.2rem; box-shadow: var(--shadow); margin-bottom:1rem; }

        .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap:1rem; }

        label { display:block; margin-bottom:0.25rem; font-weight:600; }
        input[type="text"], input[type="number"], select, textarea, input[type="date"], input[type="time"] {
            width:100%; padding:0.6rem; border-radius:8px; border:1px solid #E8EEF8; font-family:inherit;
        }

        .btn { background: var(--gradient-1); color:white; border:none; padding:0.7rem 1rem; border-radius:10px; cursor:pointer; font-weight:700; }
        .btn.secondary { background: var(--gradient-2); }
        .btn.danger { background: linear-gradient(135deg,#FF6B9D,#FF5370); }
        .btn.small { padding:0.35rem 0.6rem; font-size:0.85rem; }

        .recipe-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap:1rem; margin-top:0.5rem; }
        .recipe-preview { background:white; border-radius:12px; padding:1rem; box-shadow:0 8px 28px rgba(0,0,0,0.06); cursor:pointer; display:flex; flex-direction:column; gap:0.6rem; }
        .missing-badge { background: linear-gradient(135deg,#FEF3C7,#FDE68A); padding:0.6rem; border-radius:8px; color:#92400E; font-weight:600; }

        .material-row { display:flex; justify-content:space-between; gap:0.5rem; padding:0.6rem; border-radius:8px; background:linear-gradient(135deg,#fff,#fff9f0); align-items:center; }
        .material-actions { display:flex; gap:0.4rem; }

        .modal { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:1000; padding:1rem; }
        .modal.active { display:flex; }
        .modal-content { width:100%; max-width:820px; background:white; border-radius:12px; overflow:auto; max-height:90vh; }
        .modal-header { background:var(--gradient-1); color:white; padding:1rem; border-radius:12px 12px 0 0; display:flex; justify-content:space-between; align-items:center; }
        .modal-body { padding:1rem; }

        .cost-row { display:flex; justify-content:space-between; padding:0.4rem 0; border-bottom:1px solid rgba(0,0,0,0.04); }

        @media (max-width:720px) {
            .grid { grid-template-columns:1fr; }
            .recipe-grid { grid-template-columns:1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div>
                <h1>üïØÔ∏è <span id="appTitle">Candle Workshop</span></h1>
                <p id="appSubtitle">Professional candle production management tool</p>
            </div>
            <div class="lang-selector" aria-label="Language selector">
                <button class="lang-btn" data-lang="ro" onclick="setLang('ro', event)">üá∑üá¥</button>
                <button class="lang-btn" data-lang="en" onclick="setLang('en', event)">üá¨üáß</button>
                <button class="lang-btn" data-lang="es" onclick="setLang('es', event)">üá™üá∏</button>
                <button class="lang-btn" data-lang="fr" onclick="setLang('fr', event)">üá´üá∑</button>
                <button class="lang-btn" data-lang="de" onclick="setLang('de', event)">üá©üá™</button>
                <button class="lang-btn" data-lang="it" onclick="setLang('it', event)">üáÆüáπ</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="tabs" role="tablist" aria-label="Main tabs">
            <button class="tab-btn active" id="tbtn0" onclick="showTab(0)" role="tab">Dashboard</button>
            <button class="tab-btn" id="tbtn1" onclick="showTab(1)" role="tab">Inventory</button>
            <button class="tab-btn" id="tbtn2" onclick="showTab(2)" role="tab">Recipes</button>
            <button class="tab-btn" id="tbtn3" onclick="showTab(3)" role="tab">History</button>
            <button class="tab-btn" id="tbtn4" onclick="showTab(4)" role="tab">Calendar</button>
        </div>

        <!-- Dashboard -->
        <div class="card tab-content active" data-tab="0">
            <h2 id="alertsTitle">Stock Alerts</h2>
            <div id="alerts"></div>
        </div>

        <!-- Inventory -->
        <div class="card tab-content" data-tab="1" style="display:none;">
            <h2 id="invTitle">Add Material to Inventory</h2>
            <div class="grid" style="margin-top:0.75rem;">
                <div>
                    <label id="nameLabel">Material Name</label>
                    <input id="matName" type="text" placeholder="e.g. Soy wax">
                </div>
                <div>
                    <label id="qtyLabel">Quantity</label>
                    <input id="matQty" type="number" placeholder="e.g. 1000" min="0" step="any">
                </div>
                <div>
                    <label id="unitLabel">Unit</label>
                    <select id="matUnit">
                        <option value="g">g</option>
                        <option value="kg">kg</option>
                        <option value="ml">ml</option>
                        <option value="l">l</option>
                        <option value="pcs">pcs</option>
                    </select>
                </div>
                <div>
                    <label id="priceLabel">Price per Unit (<span id="curr">USD</span>)</label>
                    <input id="matPrice" type="number" step="0.01" placeholder="e.g. 12.50">
                </div>
                <div>
                    <label id="minLabel">Min Stock Alert</label>
                    <input id="matMin" type="number" placeholder="e.g. 200">
                </div>
            </div>
            <div style="margin-top:0.6rem; display:flex; gap:0.5rem; align-items:center;">
                <button class="btn" onclick="addMat()" id="addBtn">Add Material</button>
                <button class="btn secondary" onclick="clearInventory()">Clear Inventory</button>
            </div>

            <h3 style="margin-top:1rem;" id="invListTitle">Materials Inventory</h3>
            <div id="matList" style="margin-top:0.6rem;"></div>
        </div>

        <!-- Recipes -->
        <div class="card tab-content" data-tab="2" style="display:none;">
            <h2 id="recTitle">Pre-installed Recipes</h2>
            <div class="recipe-grid" id="recList"></div>
        </div>

        <!-- History -->
        <div class="card tab-content" data-tab="3" style="display:none;">
            <h2 id="histTitle">Production History</h2>
            <div id="histList"></div>
        </div>

        <!-- Calendar (light) -->
        <div class="card tab-content" data-tab="4" style="display:none;">
            <h2 id="calTitle">Schedule (simple)</h2>
            <p style="opacity:0.8">Add events in Calendar tab (simple implementation).</p>
            <div style="margin-top:0.6rem;" class="grid">
                <div>
                    <label id="typeLabel">Type</label>
                    <select id="evType">
                        <option value="prod">Production</option>
                        <option value="sale">Sale</option>
                    </select>
                </div>
                <div>
                    <label id="titleLabel">Title</label>
                    <input id="evTitle" type="text">
                </div>
                <div>
                    <label id="dateLabel">Date</label>
                    <input id="evDate" type="date">
                </div>
                <div>
                    <label id="timeLabel">Time</label>
                    <input id="evTime" type="time">
                </div>
            </div>
            <div style="margin-top:0.6rem; display:flex; gap:0.5rem;">
                <button class="btn" onclick="addEv()">Add Event</button>
                <button class="btn secondary" onclick="exportCal()">Export Calendar</button>
            </div>

            <h3 style="margin-top:1rem;">Scheduled Events</h3>
            <div id="evList" style="margin-top:0.5rem;"></div>
        </div>
    </div>

    <!-- Modal for recipe -->
    <div id="modal" class="modal" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modName">
            <div class="modal-header">
                <div>
                    <h3 id="modName">Recipe</h3>
                    <div id="modSubtitle" style="opacity:0.9;font-size:0.95rem;"></div>
                </div>
                <div>
                    <button class="btn small" onclick="closeMod()">Close</button>
                </div>
            </div>
            <div class="modal-body">
                <div style="display:flex; gap:0.6rem; align-items:center; margin-bottom:0.75rem;">
                    <label style="min-width:70px; font-weight:700;">Quantity</label>
                    <button class="btn small secondary" onclick="chgQty(-1)">-</button>
                    <input id="prodQty" type="number" value="1" min="1" style="width:70px; text-align:center; padding:0.45rem; border-radius:8px; border:1px solid #EEE;">
                    <button class="btn small secondary" onclick="chgQty(1)">+</button>
                </div>

                <h4>Ingredients</h4>
                <div id="modIng" style="margin-top:0.6rem;"></div>

                <div id="modMissing" style="margin-top:0.6rem;"></div>

                <h4 style="margin-top:1rem;">Instructions</h4>
                <ol id="modInstr" style="margin-top:0.6rem; padding-left:1.1rem;"></ol>

                <div class="cost-summary" style="margin-top:1rem; padding:0.8rem; border-radius:10px; background:linear-gradient(135deg,#FF6B9D,#C44569); color:white;">
                    <div id="modCost"></div>
                </div>

                <div style="display:flex; gap:0.6rem; margin-top:0.9rem;">
                    <button class="btn" onclick="produce()" id="prodBtn">Start Production</button>
                    <button class="btn secondary" onclick="closeMod()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    /*
      Rewritten index.html
      - Integrates Inventory with Recipes: missing items show an "Add to inventory" action which pre-fills
        the inventory add form and switches to the Inventory tab.
      - Fixed setLang bug and completed render flow.
      - Uses localStorage for persistence.
    */

    // Translations (subset used by the UI)
    const T = {
        en: {
            appTitle: "Candle Workshop",
            appSubtitle: "Professional candle production management tool",
            tab0: "Dashboard", tab1: "Inventory", tab2: "Recipes", tab3: "History", tab4: "Calendar",
            statLabel1: "Materials in Stock", statLabel2: "Low Stock Alerts", statLabel3: "Candles Produced", statLabel4: "Events Scheduled",
            alertsTitle: "Stock Alerts",
            nameLabel: "Material Name", qtyLabel: "Quantity", unitLabel: "Unit", priceLabel: "Price per Unit", curr: "USD",
            minLabel: "Min Stock Alert", addBtn: "Add Material", invListTitle: "Materials Inventory",
            recTitle: "Pre-installed Recipes", histTitle: "Production History", calTitle: "Calendar",
            typeLabel: "Type", titleLabel: "Title", dateLabel: "Date", timeLabel: "Time",
            addEvBtn: "Add Event", exportBtn: "Export Calendar", evListTitle: "Scheduled Events",
            missingItems: "Missing items", addToInv: "Add to inventory", fillForm: "Pre-fill inventory form",
            costLabel: "Cost", profitLabel: "Profit", priceLabelFinal: "Price"
        },
        ro: {
            appTitle: "Atelier Lum√¢nƒÉri",
            appSubtitle: "Instrument profesional pentru produc»õia de lum√¢nƒÉri",
            tab0: "Dashboard", tab1: "Inventar", tab2: "Re»õete", tab3: "Istoric", tab4: "Calendar",
            statLabel1: "Materiale √Æn stoc", statLabel2: "Alerte stoc mic", statLabel3: "Lum√¢nƒÉri produse", statLabel4: "Evenimente programate",
            alertsTitle: "Alerte Stoc",
            nameLabel: "Nume Material", qtyLabel: "Cantitate", unitLabel: "Unitate", priceLabel: "Pre»õ pe unitate", curr: "RON",
            minLabel: "AlertƒÉ minimƒÉ", addBtn: "AdaugƒÉ Material", invListTitle: "Inventarul Materialelor",
            recTitle: "Re»õete Pre-instalate", histTitle: "Istoric Produc»õie", calTitle: "Calendar",
            typeLabel: "Tip", titleLabel: "Titlu", dateLabel: "DatƒÉ", timeLabel: "Timp",
            addEvBtn: "AdaugƒÉ Eveniment", exportBtn: "ExportƒÉ Calendar", evListTitle: "Evenimente Programate",
            missingItems: "Elemente lipsƒÉ", addToInv: "AdaugƒÉ √Æn inventar", fillForm: "CompleteazƒÉ formularul",
            costLabel: "Cost", profitLabel: "Profit", priceLabelFinal: "Pre»õ"
        }
        // Additional languages could be added similarly...
    };

    const CR = { USD: 1.0, EUR: 0.92, RON: 4.0 }; // simple conversion table for example
    let L = localStorage.getItem('lang') || 'en';
    let INV = JSON.parse(localStorage.getItem('inv') || '[]');
    let HIST = JSON.parse(localStorage.getItem('hist') || '[]');
    let EVS = JSON.parse(localStorage.getItem('evs') || '[]');

    // Pre-installed recipes (subset; expanded for clarity)
    const RECS = [
        {
            id: 'r-lav-001',
            name: { en: "Relaxing Lavender Candle", ro: "Lum√¢nare LavandƒÉ RelaxantƒÉ" },
            ing: [
                { n: { en: "Soy wax", ro: "CearƒÉ de soia" }, q: 200, u: "g" },
                { n: { en: "Lavender essential oil", ro: "Ulei esen»õial de lavandƒÉ" }, q: 5, u: "ml" },
                { n: { en: "Cotton wick", ro: "Fitil de bumbac" }, q: 1, u: "pcs" },
                { n: { en: "Glass container", ro: "Recipient sticlƒÉ" }, q: 1, u: "pcs" }
            ],
            instr: [
                { en: "Clean container and center the wick.", ro: "CurƒÉ»õƒÉ recipientul »ôi centreazƒÉ fitilul." },
                { en: "Melt wax to 70¬∞C.", ro: "Tope»ôte ceara la 70¬∞C." },
                { en: "Add fragrance and pour when ready.", ro: "AdaugƒÉ uleiul »ôi toarnƒÉ." }
            ],
            pm: 60 // profit margin %
        },
        {
            id: 'r-van-001',
            name: { en: "Vanilla & Cinnamon Candle", ro: "Lum√¢nare Vanilie & Scor»õi»ôoarƒÉ" },
            ing: [
                { n: { en: "Paraffin wax", ro: "CearƒÉ de parafinƒÉ" }, q: 250, u: "g" },
                { n: { en: "Vanilla essence", ro: "Esen»õƒÉ de vanilie" }, q: 8, u: "ml" },
                { n: { en: "Cinnamon essence", ro: "Esen»õƒÉ de scor»õi»ôoarƒÉ" }, q: 3, u: "ml" },
                { n: { en: "Cotton wick", ro: "Fitil de bumbac" }, q: 1, u: "pcs" }
            ],
            instr: [
                { en: "Fix wick and melt wax to 80¬∞C.", ro: "FixeazƒÉ fitilul »ôi tope»ôte ceara la 80¬∞C." },
                { en: "Mix fragrances and pour slowly.", ro: "AmestecƒÉ esen»õele »ôi toarnƒÉ √Æncet." }
            ],
            pm: 60
        }
    ];

    // Utilities
    function setLang(l, ev) {
        if (!T[l]) return;
        L = l;
        localStorage.setItem('lang', l);
        document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.toggle('active', btn.getAttribute('data-lang') === l));
        // Update textual nodes mapped by ids in translations
        const mapKeys = ['appTitle','appSubtitle','tab0','tab1','tab2','tab3','tab4',
                         'alertsTitle','nameLabel','qtyLabel','unitLabel','priceLabel','curr','minLabel',
                         'addBtn','invListTitle','recTitle','histTitle','calTitle',
                         'typeLabel','titleLabel','dateLabel','timeLabel','addEvBtn','exportBtn','evListTitle'];
        const trans = T[l];
        if (trans) {
            // Titles
            document.getElementById('appTitle').textContent = trans.appTitle;
            document.getElementById('appSubtitle').textContent = trans.appSubtitle;
            // Tabs (we'll update text of tab buttons)
            const tb = document.querySelectorAll('.tab-btn');
            if (tb && tb.length >= 5) {
                tb[0].textContent = trans.tab0;
                tb[1].textContent = trans.tab1;
                tb[2].textContent = trans.tab2;
                tb[3].textContent = trans.tab3;
                tb[4].textContent = trans.tab4;
            }
            // Labels
            document.getElementById('alertsTitle').textContent = trans.alertsTitle;
            document.getElementById('nameLabel').textContent = trans.nameLabel;
            document.getElementById('qtyLabel').textContent = trans.qtyLabel;
            document.getElementById('unitLabel').textContent = trans.unitLabel;
            document.getElementById('priceLabel').textContent = trans.priceLabel;
            document.getElementById('curr').textContent = trans.curr;
            document.getElementById('minLabel').textContent = trans.minLabel;
            document.getElementById('addBtn').textContent = trans.addBtn;
            document.getElementById('invListTitle').textContent = trans.invListTitle;
            document.getElementById('recTitle').textContent = trans.recTitle;
            document.getElementById('histTitle').textContent = trans.histTitle;
            document.getElementById('calTitle').textContent = trans.calTitle;
        }
        render();
    }

    function conv(amt, from, to) {
        if (!from || !to || from === to) return amt;
        const usd = amt / (CR[from] || 1);
        return usd * (CR[to] || 1);
    }

    function fmtAmt(amt) {
        const v = Number(amt) || 0;
        return `${v.toFixed(2)} ${T[L].curr || 'USD'}`;
    }

    function showTab(i) {
        document.querySelectorAll('.tab-content').forEach((el, idx) => {
            const visible = idx === i;
            el.style.display = visible ? '' : 'none';
        });
        document.querySelectorAll('.tab-btn').forEach((b, idx) => b.classList.toggle('active', idx === i));
    }

    // Add material to inventory (regular add or pre-filled)
    function addMat(prefill) {
        const nameEl = document.getElementById('matName');
        const qtyEl = document.getElementById('matQty');
        const unitEl = document.getElementById('matUnit');
        const priceEl = document.getElementById('matPrice');
        const minEl = document.getElementById('matMin');

        if (prefill) {
            // prefill form and keep user in inventory
            nameEl.value = prefill.n || '';
            qtyEl.value = prefill.q || '';
            unitEl.value = prefill.u || 'pcs';
            priceEl.value = prefill.p || '';
            minEl.value = prefill.m || '';
            showTab(1);
            return;
        }

        const n = nameEl.value.trim();
        const q = parseFloat(qtyEl.value);
        const u = unitEl.value;
        const p = parseFloat(priceEl.value);
        const m = parseFloat(minEl.value);

        if (!n || isNaN(q) || isNaN(p) || isNaN(m)) {
            alert('Please fill all fields (correct types).');
            return;
        }

        // If name already exists (fuzzy), merge quantities and update price (simple behavior)
        const existing = INV.find(it => it.n.toLowerCase() === n.toLowerCase() && it.u === u);
        if (existing) {
            existing.q = Number(existing.q) + Number(q);
            existing.p = p; // override with latest price
        } else {
            INV.push({ id: Date.now(), n, q, u, p, c: T[L].curr || 'USD', m });
        }
        localStorage.setItem('inv', JSON.stringify(INV));
        nameEl.value = ''; qtyEl.value = ''; priceEl.value = ''; minEl.value = '';
        render();
        showTab(1);
    }

    function clearInventory() {
        if (!confirm('Clear entire inventory?')) return;
        INV = [];
        localStorage.setItem('inv', JSON.stringify(INV));
        render();
    }

    function delMat(id) {
        if (!confirm('Delete this material?')) return;
        INV = INV.filter(i => i.id !== id);
        localStorage.setItem('inv', JSON.stringify(INV));
        render();
    }

    // Calculate costs and missing items
    function calcCost(rec, qty = 1) {
        let tot = 0;
        const miss = [];
        const brk = [];
        rec.ing.forEach(ing => {
            const nm = (ing.n[L] || ing.n.en).toLowerCase();
            // Find matching inventory item: matches if inventory name contains ingredient name or vice-versa
            const mat = INV.find(m => {
                const mn = m.n.toLowerCase();
                return mn.includes(nm) || nm.includes(mn) || mn.split(' ')[0] === nm.split(' ')[0];
            });
            if (mat) {
                // compute unit cost: if mat unit is kg and ing unit is g => adjust
                let unitCost = mat.p; // in mat.c currency
                const matUnit = mat.u, ingUnit = ing.u;
                let costPerNeededUnit = unitCost;
                // convert kg->g or l->ml
                if (matUnit === 'kg' && ingUnit === 'g') costPerNeededUnit = unitCost / 1000;
                if (matUnit === 'l' && ingUnit === 'ml') costPerNeededUnit = unitCost / 1000;
                // assume same currency for simplicity
                const costForIngredient = costPerNeededUnit * ing.q * qty;
                tot += costForIngredient;
                brk.push({ n: (ing.n[L] || ing.n.en), q: ing.q * qty, u: ing.u, c: costForIngredient });
            } else {
                miss.push({ n: (ing.n[L] || ing.n.en), q: ing.q * qty, u: ing.u });
            }
        });
        const prf = tot * (rec.pm / 100);
        return { tot, prf, sale: tot + prf, miss, brk };
    }

    // Modal logic
    let CUR_REC = null;
    function openMod(i) {
        CUR_REC = i;
        const r = RECS[i];
        document.getElementById('modName').textContent = (r.name[L] || r.name.en);
        document.getElementById('modSubtitle').textContent = '';
        document.getElementById('prodQty').value = 1;
        updMod();
        document.getElementById('modal').classList.add('active');
        document.getElementById('modal').setAttribute('aria-hidden','false');
    }

    function closeMod() {
        CUR_REC = null;
        document.getElementById('modal').classList.remove('active');
        document.getElementById('modal').setAttribute('aria-hidden','true');
    }

    function chgQty(d) {
        const inp = document.getElementById('prodQty');
        let v = parseInt(inp.value || '0') + d;
        if (isNaN(v) || v < 1) v = 1;
        inp.value = v;
        updMod();
    }

    function updMod() {
        if (CUR_REC === null) return;
        const r = RECS[CUR_REC];
        const q = parseInt(document.getElementById('prodQty').value || '1');
        const c = calcCost(r, q);

        // Ingredients breakdown (available ones)
        document.getElementById('modIng').innerHTML = c.brk.map(b =>
            `<div class="material-row"><div><strong>${escapeHtml(b.n)}</strong><div style="opacity:0.8;font-size:0.9rem">${b.q} ${b.u}</div></div><div style="text-align:right">${fmtAmt(b.c)}</div></div>`
        ).join('');

        // Missing items area (interactive)
        const missingHtml = c.miss.length === 0 ? '<div style="margin-top:0.4rem;color:green;font-weight:700;">All ingredients available</div>' :
            `<div class="missing-badge"><strong>‚ö†Ô∏è ${T[L].missingItems}:</strong><ul style="margin:0.5rem 0 0 0.8rem;">` +
            c.miss.map(m => `<li style="margin:0.35rem 0; display:flex; justify-content:space-between; align-items:center;">
                <span>${escapeHtml(m.n)}: ${m.q} ${m.u}</span>
                <span style="display:flex; gap:0.4rem; margin-left:0.6rem;">
                    <button class="btn small" onclick='prefillAdd(${CUR_REC}, ${q}, ${JSON.stringify(escapeHtml(m.n))}, ${m.q}, "${m.u}")'>${T[L].addToInv}</button>
                </span>
            </li>`).join('') +
            `</ul></div>`;

        document.getElementById('modMissing').innerHTML = missingHtml;

        // Instructions
        document.getElementById('modInstr').innerHTML = r.instr.map(s => `<li>${escapeHtml(s[L] || s.en)}</li>`).join('');

        // Cost
        document.getElementById('modCost').innerHTML = `
            <div class="cost-row"><span>${T[L].costLabel || 'Cost'}</span><span>${fmtAmt(c.tot)}</span></div>
            <div class="cost-row"><span>${T[L].profitLabel || 'Profit'} (${r.pm}%)</span><span>${fmtAmt(c.prf)}</span></div>
            <div class="cost-row" style="font-weight:800; border-top:1px solid rgba(255,255,255,0.15); margin-top:0.4rem;"><span>${T[L].priceLabelFinal || 'Price'}</span><span>${fmtAmt(c.sale)}</span></div>
        `;
    }

    // prefillAdd called when clicking Add from missing items in modal
    function prefillAdd(recIndex, qty, nameEscaped, reqQty, unit) {
        // nameEscaped is already escaped in call; convert to plain string
        const name = (typeof nameEscaped === 'string') ? nameEscaped : String(nameEscaped);
        // open inventory tab and prefill form
        const pre = { n: name, q: reqQty, u: unit, p: '', m: '' };
        addMat(pre);
    }

    // produce: deduct inventory where available, add history item
    function produce() {
        if (CUR_REC === null) return;
        const r = RECS[CUR_REC];
        const q = parseInt(document.getElementById('prodQty').value || '1');
        const c = calcCost(r, q);
        if (c.miss.length > 0) {
            if (!confirm('Some items are missing. Produce anyway (will not deduct missing items)?')) {
                return;
            }
        }
        // Deduct quantities for matching inventory items
        r.ing.forEach(ing => {
            const nm = (ing.n[L] || ing.n.en).toLowerCase();
            const mat = INV.find(m => {
                const mn = m.n.toLowerCase();
                return mn.includes(nm) || nm.includes(mn) || mn.split(' ')[0] === nm.split(' ')[0];
            });
            if (mat) {
                // adjust units if needed (kg/g, l/ml)
                let needed = ing.q * q;
                // if mat is in kg and ing in g, convert needed to kg
                if (mat.u === 'kg' && ing.u === 'g') needed = needed / 1000;
                if (mat.u === 'l' && ing.u === 'ml') needed = needed / 1000;
                mat.q = Number(mat.q) - needed;
                if (mat.q < 0) mat.q = 0;
            }
        });
        // persist inventory
        localStorage.setItem('inv', JSON.stringify(INV));
        // add to history
        HIST.unshift({ id: Date.now(), rec: r.name[L] || r.name.en, qty: q, date: new Date().toISOString() });
        localStorage.setItem('hist', JSON.stringify(HIST));
        render();
        closeMod();
        alert('Production recorded.');
    }

    // Events/calendar (light)
    function addEv() {
        const t = document.getElementById('evType').value;
        const ti = document.getElementById('evTitle').value || '';
        const d = document.getElementById('evDate').value || '';
        const tm = document.getElementById('evTime').value || '';
        if (!d) return alert('Select a date.');
        EVS.unshift({ id: Date.now(), type: t, title: ti, date: d, time: tm });
        localStorage.setItem('evs', JSON.stringify(EVS));
        render();
        document.getElementById('evTitle').value = '';
        document.getElementById('evDate').value = '';
        document.getElementById('evTime').value = '';
    }

    function exportCal() {
        if (!EVS.length) return alert('No events to export.');
        const data = EVS.map(e => `${e.date} ${e.time || ''} - ${e.type} - ${e.title}`).join('\n');
        // simple copy to clipboard
        navigator.clipboard && navigator.clipboard.writeText(data).then(() => alert('Calendar copied to clipboard.'));
    }

    function delEv(id) {
        EVS = EVS.filter(e => e.id !== id);
        localStorage.setItem('evs', JSON.stringify(EVS));
        render();
    }

    function delHist(id) {
        HIST = HIST.filter(h => h.id !== id);
        localStorage.setItem('hist', JSON.stringify(HIST));
        render();
    }

    // Render UI
    function render() {
        // Inventory list
        const matList = document.getElementById('matList');
        if (matList) {
            if (INV.length === 0) {
                matList.innerHTML = '<div style="opacity:0.8">No materials yet.</div>';
            } else {
                matList.innerHTML = INV.map(m => `
                    <div class="material-row" title="${escapeHtml(m.n)}">
                        <div>
                            <strong>${escapeHtml(m.n)}</strong>
                            <div style="opacity:0.8;font-size:0.9rem">${m.q} ${m.u} ‚Ä¢ ${fmtAmt(m.p)} / ${m.c || ''}</div>
                        </div>
                        <div class="material-actions">
                            <button class="btn small" onclick="prefillEdit(${m.id})">Edit</button>
                            <button class="btn small danger" onclick="delMat(${m.id})">Delete</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Recipes list with missing items highlighted and actions to prefill inventory
        const recList = document.getElementById('recList');
        if (recList) {
            recList.innerHTML = RECS.map((r, i) => {
                const c = calcCost(r, 1);
                const missing = c.miss.length;
                const missHtml = missing === 0 ? `<div style="color:green;font-weight:700">All ingredients available</div>` :
                    `<div class="missing-badge">${missing} ${T[L].missingItems}</div>`;
                return `<div class="recipe-preview" onclick="openMod(${i})" role="button" tabindex="0" onkeydown="if(event.key==='Enter'){openMod(${i})}">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                        <div>
                            <h3 style="font-family:'Playfair Display',serif;margin:0;">${escapeHtml(r.name[L] || r.name.en)}</h3>
                            <div style="opacity:0.85;font-size:0.9rem;margin-top:0.25rem">${(r.ing.length)} ingredients</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:800">${fmtAmt(c.sale)}</div>
                            <div style="opacity:0.8;font-size:0.85rem">(${r.pm}% profit)</div>
                        </div>
                    </div>
                    <div style="margin-top:0.6rem;">${missHtml}</div>
                </div>`;
            }).join('');
        }

        // Alerts (low stock)
        const alerts = document.getElementById('alerts');
        if (alerts) {
            const low = INV.filter(m => !isNaN(m.m) && Number(m.q) <= Number(m.m));
            if (low.length === 0) {
                alerts.innerHTML = '<div style="opacity:0.8">All good ‚Äî no low stock alerts.</div>';
            } else {
                alerts.innerHTML = low.map(l => `<div class="alert" style="background:linear-gradient(135deg,#FEF3C7,#FDE68A); padding:0.6rem; border-radius:8px;">
                    <strong>${escapeHtml(l.n)}</strong> ‚Äî ${l.q} ${l.u} (min ${l.m})</div>`).join('');
            }
        }

        // History
        const histList = document.getElementById('histList');
        if (histList) {
            histList.innerHTML = HIST.length ? HIST.map(h => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:0.5rem;border-radius:8px;background:linear-gradient(135deg,#fff,#fff9f0);margin-bottom:0.4rem">
                    <div>
                        <strong>${escapeHtml(h.rec)}</strong>
                        <div style="opacity:0.8;font-size:0.85rem">${h.qty} pcs ‚Ä¢ ${new Date(h.date).toLocaleString()}</div>
                    </div>
                    <div><button class="btn small danger" onclick="delHist(${h.id})">Delete</button></div>
                </div>
            `).join('') : '<div style="opacity:0.8">No production history yet.</div>';
        }

        // Events
        const evList = document.getElementById('evList');
        if (evList) {
            evList.innerHTML = EVS.length ? EVS.map(e => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:0.5rem;border-radius:8px;background:linear-gradient(135deg,#fff,#fff9f0);margin-bottom:0.4rem">
                    <div>
                        <strong>${escapeHtml(e.title || e.type)}</strong>
                        <div style="opacity:0.8;font-size:0.85rem">${e.date} ${e.time || ''}</div>
                    </div>
                    <div><button class="btn small danger" onclick="delEv(${e.id})">Delete</button></div>
                </div>
            `).join('') : '<div style="opacity:0.8">No events scheduled.</div>';
        }

        // Update any modal content if open
        if (CUR_REC !== null) updMod();
    }

    // small helper to prefill edit (quick edit via inventory form)
    function prefillEdit(id) {
        const item = INV.find(i => i.id === id);
        if (!item) return;
        document.getElementById('matName').value = item.n;
        document.getElementById('matQty').value = item.q;
        document.getElementById('matUnit').value = item.u;
        document.getElementById('matPrice').value = item.p;
        document.getElementById('matMin').value = item.m;
        // After editing, delete original so user can press Add to create new one (simple approach)
        delMat(item.id);
        showTab(1);
    }

    // helper to escape HTML in dynamic strings
    function escapeHtml(s) {
        if (typeof s !== 'string') return s;
        return s.replace(/[&<>"']/g, function (m) {
            return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m];
        });
    }

    // Initialize UI
    (function init() {
        // mark language button active
        document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.toggle('active', btn.getAttribute('data-lang') === L));
        setLang(L);
        render();
    })();

    // Expose some functions to global since they're used inline
    window.setLang = setLang;
    window.showTab = showTab;
    window.addMat = addMat;
    window.clearInventory = clearInventory;
    window.delMat = delMat;
    window.openMod = openMod;
    window.closeMod = closeMod;
    window.chgQty = chgQty;
    window.prefillAdd = prefillAdd;
    window.produce = produce;
    window.addEv = addEv;
    window.exportCal = exportCal;
    window.delEv = delEv;
    window.delHist = delHist;
    window.prefillEdit = prefillEdit;
    </script>
</body>
</html>
